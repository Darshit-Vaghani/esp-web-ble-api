<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ESP32 BLE Web Console</title>

<style>
body {
  margin: 0;
  height: 100vh;
  background: #eef2f7;
  display: flex;
  justify-content: center;
  align-items: center;
  font-family: Arial, Helvetica, sans-serif;
}

.panel {
  width: 420px;
  background: #ffffff;
  border-radius: 10px;
  box-shadow: 0 8px 25px rgba(0,0,0,0.15);
  padding: 20px;
}

h2 {
  text-align: center;
  margin-top: 0;
}

.status {
  text-align: center;
  font-weight: bold;
  margin-bottom: 15px;
}

.status.disconnected { color: #c0392b; }
.status.connected { color: #27ae60; }

.buttons {
  display: flex;
  gap: 10px;
  margin-bottom: 10px;
}

button {
  flex: 1;
  padding: 10px;
  border: none;
  border-radius: 6px;
  font-size: 14px;
  cursor: pointer;
}

.connect {
  background: #007bff;
  color: white;
}

.send {
  background: #28a745;
  color: white;
}

input {
  width: 100%;
  padding: 8px;
  margin-bottom: 10px;
  border-radius: 5px;
  border: 1px solid #ccc;
}

.log {
  height: 200px;
  background: #111;
  color: #0f0;
  padding: 10px;
  font-family: monospace;
  font-size: 13px;
  overflow-y: auto;
  border-radius: 6px;
}
</style>
</head>

<body>

<div class="panel">
  <h2>ESP32 BLE Web</h2>

  <div id="status" class="status disconnected">
    Disconnected
  </div>

  <div class="buttons">
    <button class="connect" onclick="connectBLE()">Scan & Connect</button>
    <button class="send" onclick="sendData()">Send</button>
  </div>

  <input id="txInput" placeholder="Type message to send to ESP32">

  <div id="log" class="log"></div>
</div>

<script>
let device;
let rxChar;
let txChar;

/* UUIDs must match ESP32 code */
const SERVICE_UUID = 0x00FF;
const RX_UUID = 0xFF01;
const TX_UUID = 0xFF02;

function log(msg) {
  const logBox = document.getElementById("log");
  const time = new Date().toLocaleTimeString();
  logBox.innerHTML += `[${time}] ${msg}<br>`;
  logBox.scrollTop = logBox.scrollHeight;
}

async function connectBLE() {
  try {
    device = await navigator.bluetooth.requestDevice({
      acceptAllDevices: true,
      optionalServices: [SERVICE_UUID]
    });

    const server = await device.gatt.connect();
    const service = await server.getPrimaryService(SERVICE_UUID);

    rxChar = await service.getCharacteristic(RX_UUID);
    txChar = await service.getCharacteristic(TX_UUID);

    await txChar.startNotifications();
    txChar.addEventListener(
      'characteristicvaluechanged',
      event => {
        const value =
          new TextDecoder().decode(event.target.value);
        log("ESP32 → " + value);
      }
    );

    document.getElementById("status").textContent = "Connected";
    document.getElementById("status").className = "status connected";

    device.addEventListener('gattserverdisconnected', () => {
      document.getElementById("status").textContent = "Disconnected";
      document.getElementById("status").className = "status disconnected";
      log("Disconnected from ESP32");
    });

    log("Connected to " + device.name);

  } catch (err) {
    log("Error: " + err.message);
  }
}

async function sendData() {
  if (!rxChar) {
    log("Not connected");
    return;
  }

  const text = document.getElementById("txInput").value;
  if (text.length === 0) return;

  await rxChar.writeValue(
    new TextEncoder().encode(text)
  );

  log("Browser → " + text);
}
</script>

</body>
</html>
